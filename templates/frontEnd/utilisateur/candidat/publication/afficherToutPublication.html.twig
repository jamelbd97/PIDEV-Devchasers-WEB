{% extends '/frontEnd/base.html.twig' %}
{% block css %}
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="{{ asset('/frontEnd/css/bootstrap.min.css') }}" type="text/css">
    <!--Material Icon -->
    <link rel="stylesheet" type="text/css" href="{{ asset('/frontEnd/css/materialdesignicons.min.css') }}"/>
    <link rel="stylesheet" type="text/css" href="{{ asset('/frontEnd/css/fontawesome.css') }}"/>
    <link rel="stylesheet" type="text/css" href="{{ asset('/frontEnd/css/nice-select.css') }}"/>
    <!-- selectize css -->
    <link rel="stylesheet" type="text/css" href="{{ asset('/frontEnd/css/selectize.css') }}"/>
    <!-- Custom  Css -->
    <link rel="stylesheet" type="text/css" href="{{ asset('/frontEnd/css/style.css') }}"/>
{% endblock %}
{% block content %}
    {% set utilisateur = app.session.get('utilisateur') %}
    {% if utilisateur is not null %}
        {% set idUtilisateur = utilisateur['idUtilisateur'] %}
    {% else %}
        {% set idUtilisateur = null %}
    {% endif %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <section class="section pt-0 bg-light">
        <div class="bg-dark" style="height: 9rem;"></div>
        <div class="container pt-5 col-md-8 justify-content-center mx-auto">
            <a href="{{ asset('publication/ajouter') }}" class="col-md-5">
                <button class="btn btn-dark-outline my-5 w-100">Publier</button>
            </a>
            <!-- Single publication start-->
            {% if publications|length > 0 %}
                {% for publication in publications %}
                    <div class="border rounded-top bg-white shadow p-3">
                        <div class="row rounded-top pb-3">
                            <div class="col-md-2">
                                <div class="candidates-list-fav-btn text-left">
                                    <a href="#">
                                        <div class="col-md-12 candidates-listing-btn overflow-hidden">
                                            <div class="text-dark text-center my-2">
                                                <h6>{{ publication.candidat.prenom }}</h6>
                                                <h6>{{ publication.candidat.nom }}</h6>
                                            </div>
                                            <img src="/uploads/{{ publication.candidat.idPhoto }}"
                                                 alt="" class="d-block rounded shadow border mx-auto my-2" height="90">
                                            <button class="btn btn-outline-dark ml-1 p-2">Voir profil</button>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="candidates-list-desc overflow-hidden job-single-meta  pt-2">
                                    <a href="/afficherpublication/{{ publication.id }}"
                                       class="mb-2 text-dark">{{ publication.titre }}
                                    </a>
                                    <div style="font-size: 20px;"></div>

                                    <p class="mt-1 mb-0 text-break">{{ publication.description }}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="candidates-list-fav-btn text-right">
                                    <div class="candidates-listing-btn mt-2">
                                        <a href="{{ asset('/candidat/publication='~publication.id~'/modifier') }}"
                                           class="btn btn-primary-outline btn-sm mt-1">Modifier publication</a>
                                        <a href="{{ asset('/candidat/publication='~publication.id~'/supprimer') }}"
                                           class="btn btn-primary-outline btn-sm mt-1">Supprimer publication</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Like container -->
                            <div class="col-md-12 mt-5">
                                <div class="text-dark mt-3 row">
                                    {% set nbLikes = 0 %}
                                    {% set nbDislikes = 0 %}
                                    {% set hasLike = false %}
                                    {% set hasDislike = false %}

                                    {% for like in publication.likeid %}
                                        {% if like.typelike == 1 %}
                                            {% set nbLikes = nbLikes + 1 %}
                                            {% if like.idUtilisateur == idUtilisateur %}
                                                {% set hasLike = true %}
                                            {% endif %}
                                        {% else %}
                                            {% set nbDislikes = nbDislikes + 1 %}
                                            {% if like.idUtilisateur == idUtilisateur %}
                                                {% set hasDislike = true %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}

                                    <a class="col-md-2" href="#"
                                       onclick="likeDislike(0,{{ publication.id }});return false;">
                                        {% if hasDislike %}
                                            <button id="dislike-button-{{ publication.id }}" class="btn btn-dark w-100">
                                                Dislike
                                                <i id="dislike-button-heart-{{ publication.id }}"
                                                   class="mdi mdi-heart text-light"></i>
                                            </button>
                                        {% else %}
                                            <button id="dislike-button-{{ publication.id }}"
                                                    class="btn btn-outline-dark w-100">Dislike
                                                <i id="dislike-button-heart-{{ publication.id }}"
                                                   class="mdi mdi-heart-outline" style="color: red"></i>
                                            </button>
                                        {% endif %}
                                    </a>
                                    <p id="nb-dislike-{{ publication.id }}"
                                       class="col-md-1 my-auto text-center">{{ nbDislikes }}</p>
                                    <div class="col-md-6 m-auto progress-box">
                                        <div class="progress">
                                            <div id="like-bar-{{ publication.id }}"
                                                 class="progress-bar progress-bar-striped position-relative bg-dark"
                                                 style="width:{{ publication.pourcentageLike }}%">
                                            </div>
                                        </div>
                                    </div>
                                    <p id="nb-like-{{ publication.id }}"
                                       class="col-md-1 my-auto text-center">{{ nbLikes }}</p>
                                    <a class="col-md-2 w-100" href="#"
                                       onclick="likeDislike(1,{{ publication.id }});return false;">
                                        {% if hasLike %}
                                            <button id="like-button-{{ publication.id }}" class="btn btn-dark w-100">
                                                Like
                                                <i id="like-button-heart-{{ publication.id }}"
                                                   class="mdi mdi-heart text-light"></i>
                                            </button>
                                        {% else %}
                                            <button id="like-button-{{ publication.id }}"
                                                    class="btn btn-outline-dark w-100">Like
                                                <i id="like-button-heart-{{ publication.id }}" class="mdi mdi-heart"
                                                   style="color: red"></i>
                                            </button>
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 border rounded-bottom shadow mb-5" style="background: rgb(245,245,255)">
                        <div id="contenaire-commentaires-{{ publication.id }}" class="col-md-12 my-3">
                            {% for comment in publication.commentaire %}
                                <!-- Like container end -->
                                <div id="contenaire-commentaire-{{ comment.id }}"
                                     class="flex-wrap border rounded bg-white p-2" style="display: flex">
                                    <div class="col-md-1">
                                        <img src="/uploads/{{ comment.utilisateur.candidat.idPhoto }}" alt=""
                                             class="rounded-circle shadow" height="50" width="50">
                                    </div>
                                    <div class="col-md-3">
                                        <b class="col-md-12 m-0">
                                            {{ comment.utilisateur.candidat.prenom }} {{ comment.utilisateur.candidat.nom }}
                                            :
                                        </b>
                                        <p id="description-commentaire-{{ comment.id }}"
                                           class="m-0 col-md-12">{{ comment.description }}</p>
                                    </div>
                                    {% if comment.utilisateur.id == idUtilisateur %}
                                        <div class="col-md-6 my-auto mx-3">
                                            <a href="#" onclick="modifierCommentaire({{ comment.id }});return false;"><i
                                                        class="mdi mdi-pencil"></i></a>
                                            <a href="#"
                                               onclick="supprimerCommentaire({{ comment.id }});return false;"><i
                                                        class="mdi mdi-trash-can"></i></a>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <form class="col-md-12 input-group my-3" action="#">
                            <input id="input-commentaire-{{ publication.id }}" type="text"
                                   class="form-control rounded-left"
                                   placeholder="Ecrire un commentaire ...">
                            <div class="input-group-append">
                                <button id="commentaire-pub-{{ publication.id }}" type="submit"
                                        class="btn btn-primary submitBnt pt-1"
                                        onclick="ajouterCommentaire({{ publication.id }});return false;">
                                    <i class="mdi mdi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                {% endfor %}
                <!-- Single publication END-->
            {% else %}
                <div>
                    Pas de publications
                </div>
            {% endif %}
        </div>
    </section>
    <script id="ajax-like-dislike">
        function likeDislike(typeLike, idPub) {
            $.ajax({
                type: 'GET',
                url: '/like',
                data: {
                    'typeLike': typeLike,
                    'idPub': idPub
                },
                success: function (retour) {

                    obj = JSON.parse(retour);
                    if (typeLike) {
                        $("#nb-like-" + idPub).empty().append(obj.nbLike);
                        if (obj.haveLike) {
                            $('#like-button-' + idPub).attr('class', 'btn btn-outline-dark w-100');
                            $('#like-button-heart-' + idPub).attr('class', 'mdi mdi-heart').attr('style', 'color: red');
                        } else {
                            $('#like-button-' + idPub).attr('class', 'btn btn-dark w-100');
                            $('#like-button-heart-' + idPub).attr('class', 'mdi mdi-heart text-light');
                        }
                    } else {
                        $("#nb-dislike-" + idPub).empty().append(obj.nbDislike);
                        if (obj.haveDislike) {
                            $('#dislike-button-' + idPub).attr('class', 'btn btn-dark w-100');
                            $('#dislike-button-heart-' + idPub).attr('class', 'mdi mdi-heart text-light');
                        } else {
                            $('#dislike-button-' + idPub).attr('class', 'btn btn-outline-dark w-100');
                            $('#dislike-button-heart-' + idPub).attr('class', 'mdi mdi-heart-outline').attr('style', 'color: red');
                        }
                    }
                    $("#like-bar-" + idPub).attr('style', 'width:' + obj.pourcentage + '%');
                },
                error: function () {
                    alert("Connectez vous d'abord");
                }
            });

        }
    </script>
    <script id="ajax-recherche">
        $(document).ready(function () {
            $("#search").keyup(function (e) {
                var value = $("#search").val();
                console.log(value);
                $.ajax({
                    type: 'GET',
                    url: 'searchPub',
                    data: {
                        'searchValue': value
                    },
                    success: function (retour) {
                        if (retour) {
                            $.each(JSON.parse(retour), function (i, obj) {
                                $('#pub1').hide();
                                $('#tableau').empty().append("<tr><td>" + obj.id + "</td><td>" + obj.titre + "</td><td>" + obj.description + "</td></tr> ");

                                console.log("ay hkeya" + obj.titre);
                            });
                        }
                    }
                });
            })
        });
    </script>
    <script id="ajax-ajouter-commentaire">
        function ajouterCommentaire(idPublication) {
            value = $('#input-commentaire-' + idPublication).val();
            $('#input-commentaire-' + idPublication).val("");
            $.ajax({
                type: 'GET',
                url: '/commentaire/ajouter',
                data: {
                    'idPublication': idPublication,
                    'description': value,
                },
                success: function (retour) {
                    if (retour) {
                        obj = JSON.parse(retour);
                        $("#contenaire-commentaires-" + idPublication).append(
                            "<div id='contenaire-commentaire-" + obj.id + "'" +
                            " class='flex-wrap border rounded bg-white p-2' style='display: flex'>" +
                            "   <div class='col-md-1'>" +
                            "       <img src='/uploads/" + obj.idPhoto + "' alt='' " +
                            "           class='rounded-circle shadow' height='50' width='50'>" +
                            "   </div>" +
                            "   <div class='col-md-3'>" +
                            "       <b class='col-md-12 m-0'>" + obj.nomPrenom + "</b>" +
                            "       <p id='description-commentaire-" + obj.id + "' class='m-0 col-md-12'>" + obj.description + "</p>" +
                            "   </div>" +
                            "   <div class='col-md-6 my-auto mx-3'>" +
                            "       <a href='#' onclick='modifierCommentaire(" + obj.id + ");return false;'><i" +
                            "           class='mdi mdi-pencil'></i></a>" +
                            "       <a href='#' onclick='supprimerCommentaire(" + obj.id + ");return false;'><i" +
                            "           class='mdi mdi-trash-can'></i></a>" +
                            "   </div>" +
                            "</div>");
                    }
                },
                error: function () {
                    alert('Erreur ajax ajout commentaire');
                }
            });
        }
    </script>
    <script id="ajax-modifier-commentaire">
        function modifierCommentaire(idCommentaire) {

            let comment = $('#contenaire-commentaire-' + idCommentaire);
            let descriptionCommentaire = $("#description-commentaire-" + idCommentaire);


            comment.empty().append(
                "<label for='modification-commentaire-" + idCommentaire + "' class='col-md-3 my-auto'>" +
                "   modifier le commentaire : " +
                "</label>" +
                "<form class='row col-md-9 pr-0' action='#'>" +
                "   <input id='modification-commentaire-" + idCommentaire + "' type='text' class='form-control col-md-10' " +
                "           value='" + descriptionCommentaire.text() + "'>" +
                "   <a onclick='confirmerModificationCommentaire(" + idCommentaire + "," + true + ");return false;' " +
                "               class='col-md-1 my-auto' href='#'><i class='mdi mdi-check'></i></a>" +
                "   <a onclick='confirmerModificationCommentaire(" + idCommentaire + "," + false + ");return false;' " +
                "               class='col-md-1 my-auto' href='#'><i class='mdi mdi-close'></i></a>" +
                "</form>"
            );
        }

        function confirmerModificationCommentaire(idCommentaire, isModified) {
            let modifiedComment = "";
            if (isModified) {
                modifiedComment = $('#modification-commentaire-' + idCommentaire).val();
                $("#contenaire-commentaire-" + idCommentaire).empty().append('commentaire modifié');
            }
            setTimeout(function () {
                $.ajax({
                    type: 'GET',
                    url: '/commentaire/' + idCommentaire + '/modifier',
                    data: {
                        'modifiedComment': modifiedComment,
                    },
                    success: function (retour) {
                        obj = JSON.parse(retour);
                        $('#contenaire-commentaire-' + idCommentaire).empty().append(
                            "<div class='col-md-1'>" +
                            "<img src='/uploads/" + obj.idPhoto + "' alt='' " +
                            "     class='rounded-circle shadow' height='50' width='50'>" +
                            "</div>" +
                            "<div class='col-md-3'>" +
                            "    <b class='col-md-12 m-0'>" + obj.nomPrenom + "</b>" +
                            "    <p id='description-commentaire-" + obj.id + "' class='m-0 col-md-12'>" + obj.description + "</p>" +
                            "</div>" +
                            "<div class='col-md-6 my-auto mx-3'>" +
                            "   <a href='#' onclick='modifierCommentaire(" + obj.id + ");return false;'><i" +
                            "           class='mdi mdi-pencil'></i></a>" +
                            "   <a href='#' onclick='supprimerCommentaire(" + obj.id + ");return false;'><i" +
                            "           class='mdi mdi-trash-can'></i></a>" +
                            "</div>"
                        );
                    },
                    error: function () {
                        alert('Erreur ajax modification commentaire');
                    }
                });
            }, 1000);
        }
    </script>
    <script id="ajax-supprimer-commentaire">
        function supprimerCommentaire(idCommentaire) {
            $("#contenaire-commentaire-" + idCommentaire).empty().append('commentaire supprimé');
            $.ajax({
                type: 'GET',
                url: '/commentaire/' + idCommentaire + '/supprimer',
                success: function () {
                    setTimeout(function () {
                        $("#contenaire-commentaire-" + idCommentaire).remove();
                    }, 1000)
                },
                error: function () {
                    alert('Erreur ajax suppression commentaire');
                }
            });
        }
    </script>
{% endblock %}
{% block js %}
    <!-- javascript -->
    <script src="{{ asset('/frontEnd/js/jquery.min.js') }}"></script>
    <script src="{{ asset('/frontEnd/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ asset('/frontEnd/js/jquery.easing.min.js') }}"></script>
    <script src="{{ asset('/frontEnd/js/plugins.js') }}"></script>
    <!-- selectize js -->
    <script src="{{ asset('/frontEnd/js/selectize.min.js') }}"></script>
    <script src="{{ asset('/frontEnd/js/jquery.nice-select.min.js') }}"></script>
    <script src="{{ asset('/frontEnd/js/app.js') }}"></script>
{% endblock %}